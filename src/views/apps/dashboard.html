<div class="container-fluid">
  <div class="row row-deck pt-5">
    <div class="col-12 mb-3">
      <button
        class="btn btn-warning"
        data-bs-toggle="modal"
        data-bs-target="#modal-restart-all"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="icon icon-tabler icon-tabler-player-track-next-filled"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          stroke-width="2"
          stroke="currentColor"
          fill="none"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
          <path
            d="M2 5v14c0 .86 1.012 1.318 1.659 .753l8 -7a1 1 0 0 0 0 -1.506l-8 -7c-.647 -.565 -1.659 -.106 -1.659 .753z"
            stroke-width="0"
            fill="currentColor"
          ></path>
          <path
            d="M13 5v14c0 .86 1.012 1.318 1.659 .753l8 -7a1 1 0 0 0 0 -1.506l-8 -7c-.647 -.565 -1.659 -.106 -1.659 .753z"
            stroke-width="0"
            fill="currentColor"
          ></path>
        </svg>
        Restart All Applications
      </button>
      <button
        class="btn btn-danger ms-2"
        data-bs-toggle="modal"
        data-bs-target="#modal-restart-server"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="icon icon-tabler icon-tabler-power"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          stroke-width="2"
          stroke="currentColor"
          fill="none"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
          <path d="M7 6a7.75 7.75 0 1 0 10 0"></path>
          <line x1="12" y1="4" x2="12" y2="12"></line>
        </svg>
        Restart Server
      </button>
      <button
        class="btn btn-info ms-2"
        data-bs-toggle="modal"
        data-bs-target="#modal-restart-db"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="icon icon-tabler icon-tabler-database"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          stroke-width="2"
          stroke="currentColor"
          fill="none"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
          <ellipse cx="12" cy="6" rx="8" ry="3"></ellipse>
          <path d="M4 6v6a8 3 0 0 0 16 0v-6"></path>
          <path d="M4 12v6a8 3 0 0 0 16 0v-6"></path>
        </svg>
        Restart MariaDB
      </button>
    </div>
    <% apps.forEach(function (app) {%>
    <div class="col-md-3 mb-5">
      <div class="card">
        <div class="card-status-top bg-indigo"></div>
        <a
          href="/apps/<%= app.name %>"
          style="text-decoration: none; color: inherit"
        >
          <div class="card-body">
            <div class="card-title text-primary">
              <strong>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="icon icon-tabler icon-tabler-box"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                  stroke="currentColor"
                  fill="none"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                  <polyline
                    points="12 3 20 7.5 20 16.5 12 21 4 16.5 4 7.5 12 3"
                  ></polyline>
                  <line x1="12" y1="12" x2="20" y2="7.5"></line>
                  <line x1="12" y1="12" x2="12" y2="21"></line>
                  <line x1="12" y1="12" x2="4" y2="7.5"></line>
                </svg>
                <%= app.name %>
              </strong>
              <% if(app.status === "online"){ %>
              <span class="badge bg-green-lt"><%= app.status %></span>
              <% } else{ %>
              <span class="badge bg-red-lt"><%= app.status %></span>
              <% } %>
            </div>
            <h4 class="text-secondary">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="icon icon-tabler icon-tabler-server"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <rect x="3" y="4" width="18" height="8" rx="3"></rect>
                <rect x="3" y="12" width="18" height="8" rx="3"></rect>
                <line x1="7" y1="8" x2="7" y2="8.01"></line>
                <line x1="7" y1="16" x2="7" y2="16.01"></line>
              </svg>
              CPU : <%= app.cpu %> %
            </h4>
            <h4 class="text-secondary">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="icon icon-tabler icon-tabler-device-desktop-analytics"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <rect x="3" y="4" width="18" height="12" rx="1"></rect>
                <path d="M7 20h10"></path>
                <path d="M9 16v4"></path>
                <path d="M15 16v4"></path>
                <path d="M9 12v-4"></path>
                <path d="M12 12v-1"></path>
                <path d="M15 12v-2"></path>
                <path d="M12 12v-1"></path>
              </svg>
              Memory : <%= app.memory %>
            </h4>
            <h4 class="text-secondary">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="icon icon-tabler icon-tabler-calendar-time"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path
                  d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4"
                ></path>
                <circle cx="18" cy="18" r="4"></circle>
                <path d="M15 3v4"></path>
                <path d="M7 3v4"></path>
                <path d="M3 11h16"></path>
                <path d="M18 16.496v1.504l1 1"></path>
              </svg>
              Uptime : <%= app.uptime %>
            </h4>
          </div>
        </a>
        <div class="card-footer text-center">
          <% if(app.status === "online"){ %>
          <button
            class="btn btn-sm btn-green"
            aria-label="Button"
            onclick="pm2AppAction('<%= app.name %>', 'reload')"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="icon icon-tabler icon-tabler-refresh"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke="currentColor"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"></path>
              <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
            </svg>
            Reload
          </button>
          <button
            class="btn btn-sm btn-cyan"
            aria-label="Button"
            onclick="pm2AppAction('<%= app.name %>', 'restart')"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="icon icon-tabler icon-tabler-rotate-clockwise-2"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke="currentColor"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M9 4.55a8 8 0 0 1 6 14.9m0 -4.45v5h5"></path>
              <line x1="5.63" y1="7.16" x2="5.63" y2="7.17"></line>
              <line x1="4.06" y1="11" x2="4.06" y2="11.01"></line>
              <line x1="4.63" y1="15.1" x2="4.63" y2="15.11"></line>
              <line x1="7.16" y1="18.37" x2="7.16" y2="18.38"></line>
              <line x1="11" y1="19.94" x2="11" y2="19.95"></line>
            </svg>
            Restart
          </button>
          <button
            class="btn btn-sm btn-danger"
            aria-label="Button"
            onclick="pm2AppAction('<%= app.name %>', 'stop')"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="icon icon-tabler icon-tabler-circle-minus"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke="currentColor"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <circle cx="12" cy="12" r="9"></circle>
              <line x1="9" y1="12" x2="15" y2="12"></line>
            </svg>
            Stop
          </button>
          <% } else{ %>
          <button
            class="btn btn-sm btn-cyan"
            aria-label="Button"
            onclick="pm2AppAction('<%= app.name %>', 'restart')"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="icon icon-tabler icon-tabler-rotate-clockwise-2"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke="currentColor"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path d="M9 4.55a8 8 0 0 1 6 14.9m0 -4.45v5h5"></path>
              <line x1="5.63" y1="7.16" x2="5.63" y2="7.17"></line>
              <line x1="4.06" y1="11" x2="4.06" y2="11.01"></line>
              <line x1="4.63" y1="15.1" x2="4.63" y2="15.11"></line>
              <line x1="7.16" y1="18.37" x2="7.16" y2="18.38"></line>
              <line x1="11" y1="19.94" x2="11" y2="19.95"></line>
            </svg>
            Restart
          </button>
          <% } %>
        </div>
      </div>
    </div>
    <% })%>
  </div>
</div>

<!-- Add this modal at the end of the file, before the closing container div -->
<div
  class="modal modal-blur fade"
  id="modal-restart-all"
  tabindex="-1"
  role="dialog"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content bg-dark">
      <div class="modal-header bg-danger border-bottom border-danger">
        <h5 class="modal-title text-white">
          ‚ö†Ô∏è Warning: Restart All Applications
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger border-danger mb-3" role="alert">
          <div class="d-flex align-items-center">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="icon icon-tabler icon-tabler-alert-octagon me-2"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke="currentColor"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path
                d="M8.7 3h6.6c.3 0 .5 .1 .7 .3l4.7 4.7c.2 .2 .3 .4 .3 .7v6.6c0 .3 -.1 .5 -.3 .7l-4.7 4.7c-.2 .2 -.4 .3 -.7 .3h-6.6c-.3 0 -.5 -.1 -.7 -.3l-4.7 -4.7c-.2 -.2 -.3 -.4 -.3 -.7v-6.6c0 -.3 .1 -.5 .3 -.7l4.7 -4.7c.2 -.2 .4 -.3 .7 -.3z"
              ></path>
              <path d="M12 8v4"></path>
              <path d="M12 16h.01"></path>
            </svg>
            <div>
              <h4 class="alert-title text-white mb-1">
                This is a potentially dangerous action!
              </h4>
              <p class="text-white mb-0">
                You are about to restart <strong>ALL</strong> running
                applications simultaneously.
              </p>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <h4 class="text-white mb-3">
            ‚ö†Ô∏è Please consider the following risks:
          </h4>
          <ul class="list-group list-group-flush mt-2">
            <li
              class="list-group-item bg-dark text-white border-secondary d-flex align-items-center"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="icon icon-tabler icon-tabler-alert-triangle me-2 text-warning"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M12 9v4"></path>
                <path
                  d="M10.363 3.591l-8.106 13.534a1.914 1.914 0 0 0 1.636 2.871h16.214a1.914 1.914 0 0 0 1.636 -2.87l-8.106 -13.536a1.914 1.914 0 0 0 -3.274 0z"
                ></path>
                <path d="M12 16h.01"></path>
              </svg>
              <span>All services will experience downtime during restart</span>
            </li>
            <li
              class="list-group-item bg-dark text-white border-secondary d-flex align-items-center"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="icon icon-tabler icon-tabler-database-off me-2 text-warning"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path
                  d="M12.983 8.978c3.955 -.182 7.017 -1.446 7.017 -2.978c0 -1.657 -3.582 -3 -8 -3c-1.661 0 -3.204 .19 -4.483 .515m-2.783 1.228c-.471 .382 -.734 .808 -.734 1.257c0 1.22 1.944 2.271 4.734 2.74"
                ></path>
                <path
                  d="M4 6v6c0 1.657 3.582 3 8 3c.986 0 1.93 -.067 2.802 -.19m3.187 -.82c1.251 -.53 2.011 -1.228 2.011 -1.99v-6"
                ></path>
                <path
                  d="M4 12v6c0 1.657 3.582 3 8 3c3.217 0 5.991 -.712 7.261 -1.74m.739 -3.26v-4"
                ></path>
                <path d="M3 3l18 18"></path>
              </svg>
              <span>Active database connections may be interrupted</span>
            </li>
            <li
              class="list-group-item bg-dark text-white border-secondary d-flex align-items-center"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="icon icon-tabler icon-tabler-users me-2 text-warning"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0"></path>
                <path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                <path d="M21 21v-2a4 4 0 0 0 -3 -3.85"></path>
              </svg>
              <span>User sessions may be terminated</span>
            </li>
            <li
              class="list-group-item bg-dark text-white border-secondary d-flex align-items-center"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="icon icon-tabler icon-tabler-file-alert me-2 text-warning"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
                <path
                  d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"
                ></path>
                <path d="M12 17l.01 0"></path>
                <path d="M12 11l0 3"></path>
              </svg>
              <span>Unsaved data or in-progress operations may be lost</span>
            </li>
          </ul>
        </div>

        <div class="alert bg-dark-lt border border-secondary mb-0" role="alert">
          <div class="d-flex">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="icon icon-tabler icon-tabler-bulb me-2 text-warning"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke="currentColor"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
              <path
                d="M3 12h1m8 -9v1m8 8h1m-15.4 -6.4l.7 .7m12.1 -.7l-.7 .7"
              ></path>
              <path
                d="M9 16a5 5 0 1 1 6 0a3.5 3.5 0 0 0 -1 3a2 2 0 0 1 -4 0a3.5 3.5 0 0 0 -1 -3"
              ></path>
              <path d="M9.7 17l4.6 0"></path>
            </svg>
            <div>
              <h4 class="alert-title text-white mb-1">üí° Recommendation</h4>
              <p class="text-white mb-0">
                Consider restarting applications individually during off-peak
                hours to minimize disruption.
              </p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-dark border-top border-secondary">
        <button
          type="button"
          class="btn btn-link link-light me-auto"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button type="button" class="btn btn-danger" onclick="restartAllApps()">
          Yes, Restart All Applications
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Restart Server Modal -->
<div
  class="modal modal-blur fade"
  id="modal-restart-server"
  tabindex="-1"
  role="dialog"
  aria-hidden="true"
>
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <div class="modal-title">Restart Server</div>
        <div>
          Are you sure you want to restart the server? This will affect all
          running applications.
        </div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-link link-secondary me-auto"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button type="button" class="btn btn-danger" onclick="restartServer()">
          Restart Server
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Restart MariaDB Modal -->
<div
  class="modal modal-blur fade"
  id="modal-restart-db"
  tabindex="-1"
  role="dialog"
  aria-hidden="true"
>
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <div class="modal-title">Restart MariaDB</div>
        <div>
          Are you sure you want to restart the MariaDB database? This will
          temporarily disconnect all database connections.
        </div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-link link-secondary me-auto"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button type="button" class="btn btn-info" onclick="restartMariaDB()">
          Restart MariaDB
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  async function restartAllApps() {
    try {
      const response = await fetch("/api/apps/restart-all", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      console.log(data);

      // Show success message
      showNotification("success", "All applications are being restarted");
      window.location.reload();
    } catch (error) {
      console.error("Error restarting applications:", error);
      showNotification(
        "error",
        "Failed to restart applications. Please try again." + error
      );
    }
  }

  function showNotification(type, message) {
    const notificationClass =
      type === "success" ? "alert-success" : "alert-danger";
    const notification = `
      <div class="alert ${notificationClass} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    `;

    const notificationContainer = document.createElement("div");
    notificationContainer.style.position = "fixed";
    notificationContainer.style.top = "20px";
    notificationContainer.style.right = "20px";
    notificationContainer.style.zIndex = "9999";
    notificationContainer.innerHTML = notification;
    document.body.appendChild(notificationContainer);

    setTimeout(() => {
      notificationContainer.remove();
    }, 3000);
  }

  function restartServer() {
    fetch("/api/restart-server", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert("Server restart initiated. The system will reboot shortly.");
        } else {
          alert("Failed to restart server: " + data.message);
        }
      })
      .catch((error) => {
        alert("Error restarting server: " + error);
      });
  }

  function restartMariaDB() {
    fetch("/api/restart-mariadb", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert("MariaDB restart initiated successfully.");
        } else {
          alert("Failed to restart MariaDB: " + data.message);
        }
      })
      .catch((error) => {
        alert("Error restarting MariaDB: " + error);
      });
  }
</script>
